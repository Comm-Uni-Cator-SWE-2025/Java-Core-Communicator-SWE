# ==============================================================
# Linux Packaging Pipeline
# Outputs: 
#   1. .AppImage (Single executable file)
#   2. .zip (Portable folder with scripts + JRE)
# ==============================================================

trigger: none # Triggered automatically by the 'resources' below

pool:
  vmImage: 'ubuntu-latest'

resources:
  pipelines:
    - pipeline: core_build
      source: 'Java-Core-CI'   # <--- UPDATE THIS: Exact Name from Azure DevOps UI
      trigger: 
        branches:
          include:
            - main             # <--- UPDATE THIS: The branch you build on
    
    - pipeline: front_build
      source: 'Java-Front-CI'  # <--- UPDATE THIS: Exact Name from Azure DevOps UI
      trigger: 
        branches:
          include:
            - main             # <--- UPDATE THIS

variables:
  APP_NAME: 'MyCombinedApp'
  # JDK 24 Linux URL (Check https://jdk.java.net/24/ for latest hash/url)
  JAVA_URL: 'https://download.java.net/java/GA/jdk24/35/GPL/openjdk-24_linux-x64_bin.tar.gz'

steps:
  # -----------------------------
  # 1. Download Artifacts
  # -----------------------------
  - download: core_build
    artifact: core-artifact    # <--- UPDATE THIS: Must match upstream artifactName

  - download: front_build
    artifact: front-artifact   # <--- UPDATE THIS: Must match upstream artifactName

  # -----------------------------
  # 2. Prepare Directory & Smart Copy
  # -----------------------------
  - script: |
      echo "--- Setting up Directories ---"
      # We create a folder named after the APP_NAME (instead of generic 'AppDir')
      # This ensures the zip extracts into a nice folder.
      mkdir -p $(APP_NAME)/usr/bin
      mkdir -p $(APP_NAME)/usr/lib
      
      echo "--- Smart Copying JARs ---"
      # We use 'find' to ignore 'original-*.jar', 'sources.jar', etc.
      
      CORE_JAR=$(find $(Pipeline.Workspace)/core_build -name "*.jar" | grep -v "original" | grep -v "sources" | grep -v "javadoc" | head -n 1)
      echo "Selected Core: $CORE_JAR"
      cp "$CORE_JAR" $(APP_NAME)/usr/lib/java-core.jar

      FRONT_JAR=$(find $(Pipeline.Workspace)/front_build -name "*.jar" | grep -v "original" | grep -v "sources" | grep -v "javadoc" | head -n 1)
      echo "Selected Front: $FRONT_JAR"
      cp "$FRONT_JAR" $(APP_NAME)/usr/lib/java-front.jar
    displayName: "Setup Directories & Copy Jars"

  # -----------------------------
  # 3. Bundle Linux JDK 24
  # -----------------------------
  - script: |
      echo "Downloading JDK 24..."
      wget -q -O java.tar.gz $(JAVA_URL)
      
      mkdir -p $(APP_NAME)/usr/lib/jre
      # Extract stripping the root folder so 'bin' is directly inside 'jre'
      tar -xzf java.tar.gz -C $(APP_NAME)/usr/lib/jre --strip-components=1
      rm java.tar.gz
    displayName: "Bundle Java Runtime"

  # -----------------------------
  # 4. Create Launcher & Metadata
  # -----------------------------
  - script: |
      # --- Launcher Script ---
      # This script works for AppImage AND the extracted Zip
      cat > $(APP_NAME)/usr/bin/launcher.sh <<EOF
      #!/bin/bash
      HERE="\$(dirname "\$(readlink -f "\${0}")")"
      
      # Logic: If running in AppImage, root is ../../. 
      APPDIR_ROOT="\$HERE/../../"
      
      JAVA_EXEC="\$APPDIR_ROOT/usr/lib/jre/bin/java"
      
      echo "Starting Core..."
      "\$JAVA_EXEC" -jar "\$APPDIR_ROOT/usr/lib/java-core.jar" &
      PID1=\$!
      
      echo "Starting Front..."
      "\$JAVA_EXEC" -jar "\$APPDIR_ROOT/usr/lib/java-front.jar" &
      PID2=\$!
      
      trap "kill \$PID1 \$PID2" EXIT
      wait
      EOF

      # --- AppRun (AppImage Entry) ---
      cat > $(APP_NAME)/AppRun <<EOF
      #!/bin/bash
      export PATH="\$APPDIR/usr/bin:\$APPDIR/usr/lib/jre/bin:\$PATH"
      exec "\$APPDIR/usr/bin/launcher.sh" "\$@"
      EOF

      # --- Desktop File ---
      cat > $(APP_NAME)/myapp.desktop <<EOF
      [Desktop Entry]
      Name=$(APP_NAME)
      Exec=AppRun
      Icon=myapp
      Type=Application
      Categories=Utility;
      EOF

      # --- Dummy Icon ---
      wget -q -O $(APP_NAME)/myapp.png https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg

      # --- Permissions ---
      chmod +x $(APP_NAME)/AppRun
      chmod +x $(APP_NAME)/usr/bin/launcher.sh
    displayName: "Create Scripts & Metadata"

  # -----------------------------
  # 5. Build Portable ZIP
  # -----------------------------
  - script: |
      echo "Creating Portable Zip..."
      # This zips the FOLDER $(APP_NAME). 
      # When user unzips, they get a folder "MyCombinedApp/" containing the files.
      zip -r $(APP_NAME)-portable.zip $(APP_NAME)
    displayName: "Build .Zip"

  # -----------------------------
  # 6. Build AppImage
  # -----------------------------
  - script: |
      wget -q -O appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage
      chmod +x appimagetool-x86_64.AppImage
      
      # ARCH=x86_64 is required for appimagetool
      ARCH=x86_64 ./appimagetool-x86_64.AppImage $(APP_NAME) $(APP_NAME).AppImage
    displayName: "Build .AppImage"

  # -----------------------------
  # 7. Publish Artifacts
  # -----------------------------
  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(System.DefaultWorkingDirectory)'
      artifactName: 'Linux-Release-Packages'
      publishLocation: 'Container'
      # Publishes: MyCombinedApp-portable.zip AND MyCombinedApp.AppImage